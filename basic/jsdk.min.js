/*!
 * Geni JavaScript SDK
 * Copyright 2011, Ian McDaniel, Geni Inc.
 * For all api documentation:
 * http://dev.geni.com
 */

;(function(){var Geni={Version:'0.2.0',_appid:null,_status:null,_logging:false,_cookies:false,_access_token:null,_host:'http://geni.com',_url:{api:'/api',status:'/oauth/status',connect:'/oauth/authorize',disconnect:'/oauth/deauthorize',logout:'/oauth/logout'},uuid:function(){return'g'+(((1+Math.random())*0x10000)|0).toString(16).substring(1)},log:function(){if(this._logging){var args=Array.prototype.slice.call(arguments,0)||[];if(window.console)window.console.log.apply(window.console,args);if(Geni.Event)Geni.Event.trigger.apply(Geni.Event,['log'].concat(args))}},init:function(opts,cb){opts||(opts={});if(!opts.app_id){return Geni.log('Geni Javascript SDK requires an Application ID')}this._appid=opts.app_id;if(opts.access_token){this._access_token=opts.access_token;this._status="authorized"}this._logging=(window.location.toString().indexOf('geni_debug=1')>0)||opts.logging||this._logging;this._cookies=opts.cookies||this._cookies;this._host=opts.host||this._host;return this}}Geni.Util={extend:function extend(destination,source){for(var property in source)destination[property]=source[property];return destination},encodeQueryString:function(obj,prefix){var str=[];for(var p in obj)str.push(encodeURIComponent(p)+"="+encodeURIComponent(obj[p]));return str.join("&")},decodeQueryString:function(qs){var obj={},segments=qs.split('&'),kv;for(var i=0;i<segments.length;i++){kv=segments[i].split('=',2);if(kv&&kv[0]){obj[decodeURIComponent(kv[0])]=decodeURIComponent(kv[1])}}return obj}}Geni.Event={_events:{},bind:function(event,cb){this._events[event]=this._events[event]||[];this._events[event].push(cb)},unbind:function(event,cb){if(event in this._events===false)return;this._events[event].splice(this._events[event].indexOf(cb),1);if(!cb)delete this._events[event]},trigger:function(event){if(event in this._events===false)return;for(var i=0;i<this._events[event].length;i++){this._events[event][i].apply(this,Array.prototype.slice.call(arguments,1))}}}Geni.Request={callbacks:{},jsonp:function(url,params,cb){var self=this,script=document.createElement('script'),uuid=Geni.uuid(),params=Geni.Util.extend((params||{}),{callback:'Geni.Request.callbacks.'+uuid}),url=url+(url.indexOf('?')>-1?'&':'?')+Geni.Util.encodeQueryString(params);this.callbacks[uuid]=function(data){if(data.error){Geni.log([data.error,data.error_description].join(' : '))}if(cb)cb(data);delete self.callbacks[uuid]}script.src=url;document.getElementsByTagName('head')[0].appendChild(script)},oauth:function(url,params,cb){params||(params={});if(Geni._access_token){Geni.Util.extend(params,{access_token:Geni._access_token})}else{Geni.log('Geni.Request.oauth() called without an access token.')}this.jsonp(url,params,cb)},popup:function(url,params,cb){this.registerXDHandler();var screenX=typeof window.screenX!='undefined'?window.screenX:window.screenLeft,screenY=typeof window.screenY!='undefined'?window.screenY:window.screenTop,outerWidth=typeof window.outerWidth!='undefined'?window.outerWidth:document.documentElement.clientWidth,outerHeight=typeof window.outerHeight!='undefined'?window.outerHeight:(document.documentElement.clientHeight-22),width=params.width||600,height=params.height||400,left=parseInt(screenX+((outerWidth-width)/2),10),top=parseInt(screenY+((outerHeight-height)/2.5),10),features=('width='+width+',height='+height+',left='+left+',top='+top);var uuid=Geni.uuid(),params=Geni.Util.extend((params||{}),{callback:uuid,display:'popup',origin:this._origin()}),url=url+(url.indexOf('?')>-1?'&':'?')+Geni.Util.encodeQueryString(params);var win=window.open(url,uuid,features);this.callbacks[uuid]=function(data){if(cb)cb(data,win);delete Geni.Request.callbacks[uuid]}},hidden:function(url,params,cb){this.registerXDHandler();var iframe=document.createElement('iframe'),uuid=Geni.uuid(),params=Geni.Util.extend((params||{}),{callback:uuid,display:'hidden',origin:this._origin()}),url=url+(url.indexOf('?')>-1?'&':'?')+Geni.Util.encodeQueryString(params);iframe.style.display="none";this.callbacks[uuid]=function(data){if(cb)cb(data);delete Geni.Request.callbacks[uuid];iframe.parentNode.removeChild(iframe)}iframe.src=url;document.getElementsByTagName('body')[0].appendChild(iframe)},registerXDHandler:function(){if(this.xd_registered)return;var self=Geni.Request,fn=function(e){Geni.Request.onMessage(e)}window.addEventListener?window.addEventListener('message',fn,false):window.attachEvent('onmessage',fn);this.xd_registered=true},onMessage:function(e){var data={};if(e.data&&typeof e.data=='string'){data=Geni.Util.decodeQueryString(e.data)}if(data.error){Geni.log(data.error,data.error_description)}if(data.callback){var cb=this.callbacks[data.callback];if(cb){cb(data);delete this.callbacks[data.callback]}}},_origin:function(){return(window.location.protocol+'//'+window.location.host)}}Geni.Auth={getStatus:function(cb){if(!Geni._appid){return Geni.log('Geni.Auth.getStatus() called without an app id')}var url=Geni._host+Geni._url.status;Geni.Request.hidden(url,{client_id:Geni._appid},function(data){Geni.Auth.setStatus(data);if(cb)cb(data)})},connect:function(cb){if(!Geni._appid){return Geni.log('Geni.Auth.connect() called without an app id.')}if(!Geni._access_token){var url=Geni._host+Geni._url.connect,params={response_type:'token',client_id:Geni._appid};Geni.Request.popup(url,params,function(data,win){Geni.Auth.setStatus(data);if(win)win.close();if(cb)cb(data)})}else{Geni.log('Geni.Auth.connect() called when user is already connected.');if(cb)cb()}},disconnect:function(cb){if(!Geni._appid){return Geni.log('Geni.Auth.disconnect() called without an app id.')}var url=Geni._host+Geni._url.disconnect;Geni.Request.jsonp(url,{client_id:Geni._appid},function(r){Geni.Auth.setStatus(null);if(cb)cb(r)})},logout:function(cb){if(!Geni._appid){return Geni.log('Geni.Auth.logout called() without an app id.')}var url=Geni._host+Geni._url.logout;Geni.Request.jsonp(url,{client_id:Geni._appid},function(r){Geni.Auth.setStatus(null);if(cb)cb(r)})},setStatus:function(data){data||(data={});if(data.access_token){Geni._access_token=data.access_token;Geni.Cookie('geni'+Geni._appid,Geni._access_token);data.status="authorized"}else{Geni._access_token=null;Geni.Cookie('geni'+Geni._appid,null);data.status=data.status||"unknown"}if(Geni._status!=data.status){Geni.Event.trigger('auth:statusChange',data.status)}return(Geni._status=data.status)}}Geni.Api={get:function(path,params,cb){if(typeof params=='function'){cb=params;params={}}params||(params={});if(params.method){params['_method']=params.method;delete params.method}path=Geni._host+Geni._url.api+"/"+path.replace(/^\//,'');Geni.Request.oauth(path,params,cb)},post:function(path,params,cb){params=Geni.Util.extend({'_method':'post'},params||{});this.get(path,params,cb)}}Geni.Cookie=function(key,value,options){if(!Geni._cookies)return;if(arguments.length>1&&String(value)!=="[object Object]"){options=Geni.Util.extend({},options);if(value===null||value===undefined)options.expires=-1;if(typeof options.expires==='number'){var days=options.expires,t=options.expires=new Date();t.setDate(t.getDate()+days)}value=String(value);return(document.cookie=[encodeURIComponent(key),'=',options.raw?value:encodeURIComponent(value),options.expires?'; expires='+options.expires.toUTCString():'',options.path?'; path='+options.path:'',options.domain?'; domain='+options.domain:'',options.secure?'; secure':''].join(''))}options=value||{};var result,decode=options.raw?function(s){return s}:decodeURIComponent;return(result=new RegExp('(?:^|; )'+encodeURIComponent(key)+'=([^;]*)').exec(document.cookie))?decode(result[1]):null}window.Geni=window.$g=Geni.Util.extend(Geni,{getStatus:Geni.Auth.getStatus,connect:Geni.Auth.connect,disconnect:Geni.Auth.disconnect,logout:Geni.Auth.logout,api:Geni.Api.get})}).call(this);